#### 中智行

##### 项目功能介绍

仿真场景平台主要集成了 Prediction（预测）、Planning（路径规划）、Perception（感知）和 Control（控制）等模块，对常规与特殊交通场景进⾏还原推演，实现 98% 以上真实场景覆盖率，⼤幅降低⾃动驾驶的路测成本，是⼀个⾼性能、可视化智能仿真平台。

##### **存在了哪些问题**

+ 基本所以得页面内容都存放在一个主的Vue文件中
  - Vue页面大致存在大量的响应式data
  - 存在大量的watch和computed
  - 大量的Template
+ 主的Vue页面大概存在2500行，太过于大。
+ 可视化页面总会存在偶尔的卡顿现象。


##### **页面组件的拆分：**

+ content -- 主要展示区
  - 可视化区域
  - data展示和交互区
    - topic 开关
    - echart 图表
    - data 展示
+ bottom -- 底部进度条的展示

<!-- **基于组件化架构对可视化模块进⾏功能拆解和重构。**
- **功能单一性** ：每个组件应该只负责一个明确的功能，遵循单一职责原则，这样可以提高组件的可维护性和可测试性。
- **复用性** ：如果某些功能在多个地方重复使用，将其提取为独立组件可以减少代码冗余。
- **可维护性** ：拆分后的组件结构清晰，便于后续的修改和扩展。
- **数据传递** ：需要明确组件之间的数据流动方式，合理使用 props 和 emit 进行数据传递。
- **状态管理** ：对于多个组件共享的状态，可以考虑使用 Vuex 或 Pinia 进行管理。 -->

##### **页面逻辑的拆分：**

**主要的原则：**
+ 去掉Data声明所产生的大量响应式数据，因为是Vue2，大量的响应式数据可能会造成性能问题。
+ 采用面向对象的方式，用几个类来管理整个页面的渲染和展示。

1. 数据：
  - 数据连接 -- WebSocket的抽离封装（只负责连接的建立，数据的传输简单的事情，不做任何业务耦合）
    - 将WebSocket URL配置提取到环境变量中
    - 增加心跳检测机制 -- 检测客户端和服务端之间的连接是否存在问题。
    - 优化错误处理和重连逻辑 -- 设置其重连机制
    - 添加消息队列和重发机制
  
  - 数据传输、处理（每个模块的数据，数据是可以定制化，1帧，5帧，或者50帧。）

    - 模块化划分处理，在进行汇总到每一帧中。
      - carState -- 自车的相关数据（坐标，速度，加速度、routing等等信息）
      - control -- 控制组数据
      - planning -- 规划组
      - prediction -- 预测组
      - perception -- 感知组

    - 启用副线程，webWorker去处理每一帧，每个模块下的数据（就是进行相关的计算，每个图层的划分，图表数据的收集等）

      - webWorker 存在问题每次都需要手动修改文件，并且重启服务才生效，后面发现是配置项存在问题

    - 数据传输 -- 采用的是 Protocol Buffers 

      

2. 页面和渲染：

  + pageController
    - playController
    - loadData
      - WebSocket
      - webWorker
    - mapController --- 地图渲染 -- map类来管理 -- 1. 地图底图  2. 图层的渲染

  - 数据展示 -- currentFrame的展示 -- vue-json-viewer组件（）存在问题，自己重新修改了，发布新的npm包


3. 面试可能存在的问题？：

  <!-- 页面主要存在的问题:  1. 其中, 。 3. 。 4. -->
**页面主要存在的问题:**

通过Performance分析，发现存在大量的长任务，严重的阻塞了主线程，而且每一帧渲染逻辑复杂，主线程压力大。

  + 每一次需要处理的数据量特别大，每次默认传输50帧数据，所以需要大量的消耗。
  + 每一帧都存在大量数据，而且声明了很多响应式数据，导致了频繁变动，Vue 响应式系统会频繁触发依赖更新，导致大量计算和 DOM diff。
  + 每一帧 ```playBagDetailData``` 都会遍历 ```element.arrayGeojson```，大量调用 ``bagLayerUtil.addXXX/removeXXX``，这些操作会频繁触发``` mapbox 的 source/layer 增删和 setData```
  + 还存在图表和大数组的 slice/push 操作
  + 每一帧都 remove/add 图层，实际很多图层只是数据变了，不需要频繁 remove/add。
  + 可能存在的重复的深拷贝和 JSON 操作

  总的来说：1.数据处理虽然在 Worker，但主线程渲染压力大， 2.频繁的地图操作导致主线程阻塞。3.Vue 响应式和批量数据更新。 4.动画/播放驱动频率高。5.地图和图表数据未做降采样/合并

  1. 如何提升渲染性能？
      - ```requestAnimationFrame``` 采用替代定时器逻辑进⾏动画帧控制，实现帧同步。避免了 setInterval 可能出现的**间隔跳过和多个定时器连续执行**的问题，让动画播放逻辑更加流畅和高效

      - 采用 ```requestIdleCallback``` 闲时渲染减轻每一帧的渲染压力。

      - ```Web Worker``` 采用副线程来处理复杂的计算和一些图层渲染数据收集的处理（一些routing，图表数据等等）。

      - 利⽤ ```Proto Buffer``` 编码结构优化数据格式，大大减少了数据传输的开销，相应更快。 1. 通过实验，将每次50帧的数据传输改成每次5帧的数据传输，传输效率最佳。大大减少了传输时间和处理效率。 2. ⾃定义数据解析 -- 自定义Proto，并且通过protobufjs进行解析。

      - 重构Map渲染类（类似添加source，layer缓存，），深度集成 Mapbox GL，引⼊复杂道路结构、信号灯、⻋道线、动态⽬标等图层渲染逻辑，构建了⽀持缩放控制、图层切换、交互反馈的⾼还原度仿真地图系统。

        + 添加了source，layer缓存，不需要每次都需要add，或者remove。getLayer等相关也会有消耗

        + 整合相同类型的图层，类似于line，障碍物等合并成一个图层，原来是分开的，存在大概20几个图层，缩减到大致10个以内

        + DIFF每个图层的变化内数据的变化（类似为每个 geojson 图层维护一个 hash（如 JSON.stringify 后的 md5），只有数据变化时才 setData。）

        + geoJson数据的采样和抽稀
      - 去掉不必要的响应式数据，保留当前帧的数据即可。

      - 减少图表的大量slice/push

      - 减少内部实现的时候的大量数据的 免重复的深拷贝和 JSON 操作

      - 内存的大量开销，一些对象属性频繁的访问，删除等等

  2. 如何实现⼤规模仿真数据的流式处理？

      + 一个是重构的WebSocket，利用WebSocket来进行前后端的流式数据传输。
        - 增加心跳检测机制
        - 优化错误处理和重连逻辑
        - 添加消息队列和重发机制

      + 通过```Proto Buffer```高效的编码结构优化数据格式，大大减少了数据传输的开销

        - **高效的数据序列化** ：Proto是一种轻量高效的数据序列化方案，与传统的XML和JSON相比，它的序列化和反序列化速度更快，二进制编码使其占用的存储空间更小，在大规模的分布式系统中，能有效降低网络开销和存储成本

        - **跨语言和跨平台** ：定义的数据结构可以在不同的编程语言和平台之间方便地传递，保证数据的一致性和有效性。用户编写完proto文件后，可使用Google提供的protoc工具将其转换为不同语言的代码模板，如Java、Python、**C++**等，便于开发者在不同环境中使用。

  3. 为什么选择使⽤ Web Workers，具体解决了什么问题？

      - 减轻主线程压力，将大量计算，转化Proto Buffer数据等。

  4. 地图渲染中遇到哪些性能瓶颈，怎么解决的？

      - 大量的GeoJSON数据 -- 进行抽稀
      - 频繁的add和remove操作 -- source和Layer进行缓存，不需要每次新增和删除
      - 合理的图层拆分 -- 减少不必要的图层，合并相同图层，减少开销。
      - 类似更多的频繁交互可以添加防抖和节流等

  5. 如何保障系统在连续运⾏时的稳定性？

      - Chrome DevTools 、 Performance API 、 内存分析，排除内存泄漏问题，其实最主要是记得变量的销毁
      - 大数据计算和处理时，包上```try - catch```, 进行主要报错等

  6. 如何提升⾼并发下的交互流畅性？

  7. 做了哪些可视化模块的重构？⽬标是什么？

      - 页面 -- 组件化

      - 逻辑 -- 面向对象

      主要的目标是可维护性，逻辑和组件的单一性，一些逻辑的复用性

  8. 项⽬中使⽤ Proto Buffer 是基于什么考虑？

      - **高效的数据序列化** ：Proto是一种轻量高效的数据序列化方案，与传统的XML和JSON相比，它的序列化和反序列化速度更快，二进制编码使其占用的存储空间更小，在大规模的分布式系统中，能有效降低网络开销和存储成本
      - **跨语言和跨平台** ：定义的数据结构可以在不同的编程语言和平台之间方便地传递，保证数据的一致性和有效性。用户编写完proto文件后，可使用Google提供的protoc工具将其转换为不同语言的代码模板，如Java、Python、**C++**等，便于开发者在不同环境中使用。

  9. 如何实现不同交通场景的可视化与控制？

  不存在可视化内容中，主要是可以利用，场景建设，也就是说通过每个模块的输入，进行特殊模块的建设。

  10. 在地图交互⽅⾯有哪些⽤户体验优化？

  <!-- 问题
  每帧都生成大量对象，内存占用高，GC 压力大。
  旧帧数据未及时释放。
  优化建议
  a. 及时清理无用数据
  做法：只保留当前窗口帧的数据，历史帧及时清理。
  收益：降低内存占用，减少 GC 卡顿。
  b. 对象池/复用
  做法：如 geojson 对象可复用，避免频繁 new。
  收益：减少内存碎片和 GC。 -->

  参考：
  + [如何提升 JS 代码性能](https://www.yuque.com/u1598738/vqazlv/vrb4gg673bfzmptt)
  + [详解 Vue 性能优化](https://www.yuque.com/u1598738/vqazlv/vr1dgahq69nk118s)



#### 集牛智能运营平台

+ 公司背景： 基于企业微信生态，为保险公司代理人团队提供包括保险专业服务输出、微信多场景展业经营以及产品销售推动的数字化智能系统。主要是利用企业微信这个生态(因为企微是专为企业打造的专业办公管理工具)，目的是为了解决代理人和客户之间难沟通，难维护的痛点。我们可以通过技术埋点(事件埋点，页面埋点)为代理人的客户打上标签，通过多媒体库为客户推送相关资讯，模拟训练（为代理人模拟对话场景）等。为代理人更好地去开展自己的业务。

+ 工作内容：主要是有三端(PC端， H5-活动页，小程序)，对业务模块的更新迭代，对多端进行迭代和更新维护。除了业务上，还有一些基础服务的封装和共用组件的封装（路由跳转的封装，企微SDK的封装和环境的mook -- JS-SDK的调用，路由权限的设计）

##### 需要注意的点：

+ 工作内容

  PC -- 运营系统的配置页面
  H5 -- 相关活动页的开发

+ 路由跳转的封装。 --- 问题，解决方案，做到了那些场景。

  问题：
      1. 企微生态携带的各类公共参数，每次跳转都需要手动输入。

        跳转前：做了commonParams的处理
          sessionId: getSessionId(),
          corpId: obj.query.corpId || getQueryString('corpId'),
          tenantId: obj.query.tenantId || getQueryString('tenantId'),
          agentId: obj.query.agentId || getQueryString('agentId')

      2. 因为页面自定义分享失效的问题
         
        区分布页面内的那些是不需要自定义分享，单页面的，设置白名单。在跳转前去判别一下。
        如果是在白名单内则是直接router进行跳转，如不是则采用location.href进行跳转。


      3. getUrl的优化

        为了解决寻找正确的页面地址 -- 还是基于自定义分享 -> A端 -> C端时，或者不同开发人员去寻找自定义分享的页面地址。
        不是很友好 -- 页面地址不确定，参数不确定等因数。

        后在这一块去添加了getUrl的方法，只需要知道该路由的name和传入必要的参数，方法就可以自定义给返回出完整的url

        实现原理 --- 利用router的path ---> 拿到path再加上相应的params --> 就可以做拼接处完整的url

      ```js
      let shareData = {
        title: this.actInfo.shareTitle,
        desc: this.actInfo.shareDesc,
        link: this.$router.JNLocation.getUrl({
          // name: 'limitTimeGiftReceive',
          name: 'inviteNewcomerCustomer',
          query: {
            actId: this.query.actId,
            userId: this.userInfo.userid,
            uniqueKey: this.userInfo.uniqueKey,
            rootGuid: rootGuid,
          }
        }),
        imgUrl: this.actInfo.sharePhoto
      };
      ```
  由于项目 xxx 原因(S)，我需要进行 xxx 改进(T)，然后进行了 xxx 处理(A)，最后产出了 xxx 结果，数据对比为 xxx 

+ 企微SDK封装 --- mook功能的模拟，本质js-sdk的一些注册操作

  问题：
    1. 基于依靠企业微信生态，调用企微的一些api需要做一些全局的注册

      + 根据官网的JS-SDK的的调用方法做一些封装。

    2. 因为我们程序是依托企微内的应用，因此开发环境也只能在微信开发者工具内打开，或者注释掉校验等
       非常不利于开发和实际场景的模拟

      + 做一个mock的处理，判断是不是开发环境，是开发环境的话，则手动修改userAgent，并且将根据url上mookdebuger的枚举值，去模拟各类环境和不同的用户。当然js-sdk这一块我们也是去模拟了一下流程。争取去做到接近真实环境嘛。 -- 主要是为了方便去更好的开发

+ 权限控制 -- 菜单路由，路由权限 (路由前端书写， 菜单后端返回， 通过Map表去维护)

  问题： 后管路由权限的设计

    权限 --  分为路由的权限， 菜单权限， 按钮权限

      1. 路由的权限

         按需挂载，路由就需要知道用户的路由权限，也就是在用户登录进来的时候就要知道当前用户拥有哪些路由权限

      2. 菜单权限

         如果路由很多，可以在应用初始化的时候，只挂载不需要权限控制的路由。取得后端返回的菜单后，根据菜单与路由的对应关系，筛选出可访问的路由，通过addRoutes动态挂载

         菜单需要与路由做一一对应，前端添加了新功能，需要通过菜单管理功能添加新的菜单，如果菜单配置的不对会导致应用不能正常使用
         全局路由守卫里，每次路由跳转都要做判断

      3. 按钮权限 -- v-if

+ 监控平台的搭建 -- error的封装上报(错误类型，错误页面，报错时间之类的收集)

  + 资源加载报错的收集  --  window.addEventListener('error' () => {})

  + js执行报错  --  window.onerror = () => {}

  + Promise的报错收集  --  window.addEventListener('unhandledrejection' () => {})

  + Vue报错的收集  --  Vue.config.errorHandle = () => {}


+ 基础公用组件的封装 
  
  + 上传组件
  + 弹框组件
  + 图片预览等等

+ 埋点相关

  + 介绍
    埋点主要是包括访问数（Visits），访客数（Visitor），停留时⻓（Time On Site），⻚⾯浏览数（Page Views）和跳
    出率（Bounce Rate）。这样的信息收集可以⼤致分为两种：⻚⾯统计（track this virtual page view），统
    计操作⾏为（track this button by an event）。采集到的⽤户⾏为数据可以⽤于营销活动、⾏为分析、报表
    ⽣成等⽤途。

  + TrackPage -- 页面埋点 -- 页面code，页面名称，页面title之类的页面相关信息

  + TrackEvent -- 事件埋点 -- 主要是记录用户的一些行为操作 -- 事件的相关信息

  + 作用
    1、在做产品分析的时候，埋点可以在应⽤中特定的流程收集⼀些信息，⽤来跟踪应⽤使⽤的状况，后续⽤来进
    ⼀步优化产品或是提供运营的数据⽀撑。
    2、通过⽤户⾏为分析产品是否有问题，例如⽤户有没有因为设计按钮过多导致⽤户⾏为⽆效等问题，以此发
    现功能设计缺陷等。
    3、根据⻚⾯埋点可以得到⼀些重要信息，它会告诉你⽤户对⽹站的反应，如何提⾼⽹站流量、改进⽹站性
    能。了解⽤户访问⽹站的⾏为，为更好地满⾜⽤户需求提供⽀持

+ 工程化相关的工作 --- 打包，性能优化上的问题

+ 移动端常见的兼容性问题

  1. 禁止iOS识别长串数字为电话

    解决方案：<meta content="telephone=no" name="format-detection" />

  2. 禁止iOS弹出各种操作窗口

    解决方案：-webkit-touch-callout:none
  
  3. 禁止iOS和Android用户选中文字

    解决方案：-webkit-user-select:none
  
  4. 


#### 广告智能投放平台

+ 公司背景：是一个ToB的服务概念，主要是基于 Vue 和 element-ui 等技术，为广告公司提供包括广告选址，大屏广告投放以及广告运营管理等相关功能 的数字化智能系统。

  










      


  

  